---

  - hosts: all
    become: yes

    vars:
      jenkins_repo_url: http://pkg.jenkins.io/redhat
      jenkins_gpg_key_url: https://pkg.jenkins.io/redhat/jenkins.io.key
      java_package: java-1.8.0-openjdk.x86_64
      jenkins_plugins:
        - cloudbees-folder
        - jdk-tool
        - script-security
        - command-launcher
        - structs
        - bouncycastle-api
        - workflow-step-api
        - scm-api
        - workflow-api
        - junit
        - antisamy-markup-formatter
        - token-macro
        - build-timeout
        - credentials
        - ssh-credentials
        - plain-credentials
        - credentials-binding
        - timestamper
        - workflow-support
        - durable-task
        - workflow-durable-task-step
        - matrix-project
        - resource-disposer
        - ws-cleanup
        - ant
        - gradle
        - pipeline-milestone-step
        - jquery-detached
        - jackson2-api
        - ace-editor
        - workflow-scm-step
        - workflow-cps
        - pipeline-input-step
        - pipeline-stage-step
        - workflow-job
        - pipeline-graph-analysis
        - pipeline-rest-api
        - handlebars
        - momentjs
        - pipeline-stage-view
        - pipeline-build-step
        - pipeline-model-api
        - pipeline-model-extensions
        - apache-httpcomponents-client-4-api
        - jsch
        - git-client
        - git-server
        - workflow-cps-global-lib
        - display-url-api
        - mailer
        - branch-api
        - workflow-multibranch
        - authentication-tokens
        - docker-commons
        - workflow-basic-steps
        - docker-workflow
        - pipeline-stage-tags-metadata
        - pipeline-model-declarative-agent
        - pipeline-model-definition
        - lockable-resources
        - workflow-aggregator
        - github-api
        - git
        - github
        - github-branch-source
        - pipeline-github-lib
        - mapdb-api
        - subversion
        - ssh-slaves
        - matrix-auth
        - pam-auth
        - ldap
        - email-ext

    tasks:

      - name: Install Java
        yum:
          name: "{{ java_package }}"
          state: present

      - name: Add Jenkins yum repo
        yum_repository:
          name: jenkins
          description: Jenkins
          baseurl: "{{ jenkins_repo_url }}"
          gpgcheck: yes
          gpgkey: "{{ jenkins_gpg_key_url }}"

      - name: Open Jenkins port
        firewalld:
          port: 8080/tcp
          permanent: true
          state: enabled

      - name: Install Jenkins
        yum:
          name: jenkins
          state: latest

      - name: Ensure Jenkins is started
        service:
          name: jenkins
          state: started
          enabled: yes

      - name: Pause for Jenkins service to start
        pause:
          seconds: 30

      - name: Get Jenkins admin password
        shell: cat /var/lib/jenkins/secrets/initialAdminPassword
        register: jenkins_admin_password

      - name: Ensure installed_plugins directory exists
        file:
          name: installed_plugins
          state: directory
        become: no

      - name: Ensure jenkins plugins are installed
        shell: "sudo java -jar /var/cache/jenkins/war/WEB-INF/jenkins-cli.jar -s http://127.0.0.1:8080/ -auth admin:{{ jenkins_admin_password.stdout }} install-plugin {{ item }} && touch installed_plugins/{{ item }}.success"
        args:
          creates: "installed_plugins/{{ item }}.success"
        with_items:
          - "{{ jenkins_plugins }}"
        register: plugins
        become: no

      - name: Restart jenkins if required
        service:
          name: jenkins
          state: restarted
        when: plugins.changed

      - name: Ensure jenkins admin user has been created
        script: scripts/create_admin_user.sh
        args:
          creates: jenkins_admin_user.success
        become: no

      - name: Output password to user
        debug:
          msg: "The administrator password for Jekins is {{ jenkins_admin_password.stdout }}"
